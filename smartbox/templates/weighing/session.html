{% extends "base.html" %}

{% block content %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
    .weighing-container { font-family: 'Inter', sans-serif; background-color: #f3f4f6; display: grid; grid-template-rows: auto 1fr auto; height: 100vh; width: 100%; padding: 1.5rem; gap: 1.5rem; box-sizing: border-box; }
    .mode-selection-card { cursor: pointer; transition: all 0.2s ease-in-out; }
    .mode-selection-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.1) !important; }
    .step-item.active { font-weight: bold; color: #0d6efd; }
    .step-connector { border-left: 2px dashed #dee2e6; height: 1.5rem; margin-left: 1.2rem; }
    .step-icon { width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; background-color: #e9ecef; color: #495057; font-weight: bold; }
    .step-item.active .step-icon { background-color: #0d6efd; color: white; }
</style>

<div class="weighing-container">
    <header class="row align-items-center">
        <div class="col">
            <h1 id="user-greeting" class="h4">Bitte anmelden...</h1>
        </div>
        <div class="col text-end">
            <p class="mb-0 text-secondary">{{ _('Guthaben') }}</p>
            <strong id="balance-display" class="h5">-.-- €</strong>
            <button id="cart-toggle-btn" class="btn btn-sm btn-outline-primary position-relative ms-2">
                Warenkorb <span id="cart-counter" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">0</span>
            </button>
        </div>
    </header>

    <main id="main-display" class="row flex-grow-1 justify-content-center align-items-center">
        </main>
    
    <footer class="card shadow-sm">
        <div class="card-header small text-muted">Hardware-Simulation</div>
        <div class="card-body p-2">
            <div class="d-flex flex-wrap justify-content-center align-items-center gap-2">
                <div class="input-group input-group-sm flex-grow-1" style="min-width: 200px;"><input type="text" id="sim-customer-rfid" class="form-control" placeholder="Kunden-RFID..." value="RFID-CUST-MAX"><button id="sim-login-btn" class="btn btn-secondary">Login</button></div>
                <div class="input-group input-group-sm flex-grow-1" style="min-width: 300px;"><input type="text" id="sim-box-rfid" class="form-control" placeholder="Box-RFID..." value="RFID-BOX-001"><input type="number" id="sim-weight-before" class="form-control" placeholder="Gew. vorher (g)"><button id="sim-scan-btn" class="btn btn-primary">Box Scannen</button></div>
                <div class="input-group input-group-sm flex-grow-1" style="min-width: 200px;"><input type="number" id="sim-weight-after" class="form-control" placeholder="Gew. nachher (g)"><button id="sim-confirm-btn" class="btn btn-success">Bestätigen</button></div>
            </div>
        </div>
    </footer>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="shoppingCart" aria-labelledby="shoppingCartLabel">
    <div class="offcanvas-header"><h5 class="offcanvas-title" id="shoppingCartLabel">Warenkorb</h5><button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button></div>
    <div class="offcanvas-body" id="cart-items"><p class="text-muted text-center p-3">{{ _('Noch keine Artikel hinzugefügt.') }}</p></div>
    <div class="offcanvas-footer p-3 border-top"><div class="d-flex justify-content-between fw-bold"><span>{{ _('Gesamt:') }}</span><span id="cart-total">0.00 €</span></div></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // === App-Zustand ===
        let appState = 'AWAITING_USER'; // Haupt-Zustand (AWAITING_USER, MODE_SELECTION, PROJECT_SELECTION, FREE_WITHDRAWAL)
        let freeWithdrawalState = 'AWAITING_BOX'; // Unter-Zustand für die freie Entnahme
        let currentUser = null;
        let availableProjects = [];
        let currentBox = null;
        let cart = [];

        // === UI-Elemente ===
        const ui = {
            greeting: document.getElementById('user-greeting'),
            balance: document.getElementById('balance-display'),
            display: document.getElementById('main-display'),
            sim: {
                loginBtn: document.getElementById('sim-login-btn'),
                scanBtn: document.getElementById('sim-scan-btn'),
                confirmBtn: document.getElementById('sim-confirm-btn')
            }
        };

        // === HTML-Vorlagen für die verschiedenen Ansichten ===
        const viewTemplates = {
            'AWAITING_USER': `<div class="col-md-6 text-center"><div class="card shadow-sm p-5"><h2>Willkommen!</h2><p class="lead">Bitte Kundenkarte scannen.</p></div></div>`,
            'MODE_SELECTION': `
                <div class="col-md-5 text-center"><div class="card shadow-sm p-5 mode-selection-card" id="free-mode-btn"><i class="fa-solid fa-hand fa-3x mb-3"></i><h3>Freie Entnahme</h3><p class="text-muted">Materialien frei nach Bedarf entnehmen.</p></div></div>
                <div class="col-md-5 text-center"><div class="card shadow-sm p-5 mode-selection-card" id="project-mode-btn"><i class="fa-solid fa-list-check fa-3x mb-3"></i><h3>Auftragsentnahme</h3><p class="text-muted">Geführte Entnahme für ein Projekt.</p></div></div>`,
            'PROJECT_SELECTION': (projects) => {
                if (!projects || projects.length === 0) {
                    return `<div class="col-md-6 text-center"><div class="card shadow-sm p-5"><h2>Keine Projekte</h2><p class="lead">Es sind aktuell keine Projekte verfügbar.</p></div></div>`;
                }
                let projectHTML = projects.map(p => `
                    <div class="col-md-4 mb-3"><div class="card h-100" style="cursor: pointer;" onclick="window.selectProject(${p.id})">
                        <img src="${p.image_url || '/static/images/placeholder.jpg'}" class="card-img-top" alt="${p.name}"><div class="card-body"><h5 class="card-title">${p.name}</h5></div>
                    </div></div>`).join('');
                return `<div class="col-12"><h2 class="text-center mb-4">Bitte ein Projekt auswählen</h2><div class="row">${projectHTML}</div></div>`;
            },
            'FREE_WITHDRAWAL': `
                <div class="col-md-4">
                    <div class="card shadow-sm h-100"><div class="card-body">
                        <h5 class="card-title mb-4">Ablauf</h5>
                        <div id="step-fw-0" class="step-item d-flex align-items-center mb-2"><div class="step-icon">1</div><span class="ms-3">Karte aufgelegt</span></div>
                        <div class="step-connector"></div>
                        <div id="step-fw-1" class="step-item d-flex align-items-center mb-2"><div class="step-icon">2</div><span class="ms-3">Box auf Waage stellen</span></div>
                        <div class="step-connector"></div>
                        <div id="step-fw-2" class="step-item d-flex align-items-center mb-2"><div class="step-icon">3</div><span class="ms-3">Material entnehmen</span></div>
                        <div class="step-connector"></div>
                        <div id="step-fw-3" class="step-item d-flex align-items-center"><div class="step-icon">4</div><span class="ms-3">Entnahme abschließen</span></div>
                        <p class="text-center mt-2 text-primary fs-4">⟳</p>
                    </div></div>
                </div>
                <div class="col-md-8 d-flex flex-column">
                    <div class="card shadow-sm flex-grow-1"><div id="process-step-display" class="card-body d-flex flex-column justify-content-center align-items-center text-center p-5"></div></div>
                </div>`
        };
        
        const freeWithdrawalTemplates = {
            'AWAITING_BOX': { step: 1, html: () => `<h2 class="card-title">Nächster Artikel</h2><p class="lead">Bitte eine Box auf die Waage stellen.</p>` },
            'WITHDRAWAL': { step: 2, html: (box) => `<h2 class="card-title">Material entnehmen</h2><p class="lead"><strong>Material:</strong> ${box ? box.name : '...'}</p><p>Bitte Gewicht nach der Entnahme eingeben und bestätigen.</p>` },
            'TRANSACTION_SUMMARY': { step: 3, html: (t) => `<h2 class="card-title text-success">Vielen Dank!</h2><p class="lead">Entnahme verbucht: ${t.amount}g ${t.name} für ${t.price.toFixed(2)}€.</p>` }
        };
        
        // === API-Aufrufe ===
        async function apiCall(endpoint, data = {}) {
            try {
                const response = await fetch(`/weighing${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const responseData = await response.json();
                if (!response.ok) {
                    alert(`Fehler: ${responseData.message || 'Unbekannter Fehler'}`);
                    return null;
                }
                return responseData;
            } catch (error) {
                alert('Kommunikationsfehler mit dem Server.');
                return null;
            }
        }

        async function fetchProjects() {
            const data = await apiCall('/api/projects');
            if (data) { availableProjects = data.projects; }
        }
        
        // === Event Handler / Steuerungslogik ===
        async function handleLogin() {
            const rfid = document.getElementById('sim-customer-rfid').value;
            if (!rfid) return;
            try {
                const loginData = await apiCall('/api/session/login', { rfid_uid: rfid });
                if (loginData && loginData.status === 'ok') {
                    currentUser = loginData.customer;
                    await fetchProjects();
                    setState('MODE_SELECTION');
                }
            } catch (error) {
                console.error("Login-Fehler:", error);
                alert("Ein Fehler ist aufgetreten.");
            }
        }

        async function handleScanBox() {
            const rfid = document.getElementById('sim-box-rfid').value;
            const weight_before = document.getElementById('sim-weight-before').value;
            if (!rfid) return;
            const data = await apiCall('/api/session/scan_box', { box_rfid: rfid, weight_before: weight_before });
            if (data) {
                currentBox = data.box;
                freeWithdrawalState = 'WITHDRAWAL';
                renderUI();
            }
        }

        async function handleConfirm() {
            const weight_after = document.getElementById('sim-weight-after').value;
            if (!weight_after) { alert('Bitte Gewicht nach der Entnahme eingeben.'); return; }
            const data = await apiCall('/api/session/confirm', { weight_after: weight_after });
            if (data) {
                if (data.transaction) {
                    currentUser.balance = data.new_balance;
                }
                freeWithdrawalState = 'TRANSACTION_SUMMARY';
                renderUI(data.transaction);
                
                setTimeout(() => {
                    currentBox = null;
                    freeWithdrawalState = 'AWAITING_BOX';
                    renderUI();
                }, 4000);
            }
        }        

        function handleModeSelection(mode) {
            if (mode === 'free') {
                setState('FREE_WITHDRAWAL');
            } else if (mode === 'project') {
                setState('PROJECT_SELECTION');
            }
        }

        // Globale Funktion für onclick im HTML
        window.selectProject = (projectId) => {
            alert("Projekt " + projectId + " ausgewählt. Der geführte Prozess startet jetzt (Platzhalter).");
        };

        function setState(newState) { appState = newState; renderUI(); }

        // === UI-Rendering ===
        function renderUI(extraData = null) {
            ui.greeting.textContent = currentUser ? `Hallo, ${currentUser.firstName}!` : 'Bitte anmelden...';
            ui.balance.textContent = currentUser ? `${currentUser.balance.toFixed(2)} €` : '-.-- €';
            ui.display.innerHTML = viewTemplates[appState];

            if (appState === 'MODE_SELECTION') {
                document.getElementById('free-mode-btn').addEventListener('click', () => setState('FREE_WITHDRAWAL'));
                document.getElementById('project-mode-btn').addEventListener('click', () => { /* Logik für Projektauswahl */ });
            } else if (appState === 'FREE_WITHDRAWAL') {
                const fw_ui = {
                    steps: { 0: document.getElementById('step-fw-0'), 1: document.getElementById('step-fw-1'), 2: document.getElementById('step-fw-2'), 3: document.getElementById('step-fw-3') },
                    display: document.getElementById('process-step-display')
                };

                Object.values(fw_ui.steps).forEach(el => el.classList.remove('active'));
                fw_ui.steps[0].classList.add('active');
                
                const activeStepInfo = freeWithdrawalTemplates[freeWithdrawalState];
                if (activeStepInfo) {
                    const activeStepElement = fw_ui.steps[activeStepInfo.step];
                    if (activeStepElement) activeStepElement.classList.add('active');
                    
                    const dataForTemplate = extraData || currentBox;
                    fw_ui.display.innerHTML = activeStepInfo.html(dataForTemplate);
                }
            }
        }

        ui.sim.loginBtn.addEventListener('click', handleLogin);
        ui.sim.scanBtn.addEventListener('click', handleScanBox);
        ui.sim.confirmBtn.addEventListener('click', handleConfirm);
        
        renderUI();
    });
</script>
{% endblock %}